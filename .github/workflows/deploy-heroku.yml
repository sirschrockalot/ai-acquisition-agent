name: üöÄ Deploy Container to Heroku

on:
  workflow_run:
    workflows: ["üîÑ CI/CD Pipeline - Test & Build"]
    types: [completed]
    branches: [ main ]
  workflow_dispatch:

env:
  HEROKU_APP_NAME: ai-acquisition-agent

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: üöÄ Checkout code
      uses: actions/checkout@v4
      
    - name: üîê Setup Heroku CLI
      run: |
        # Check if required secrets are available
        if [ -z "${{ secrets.HEROKU_API_KEY }}" ]; then
          echo "‚ùå HEROKU_API_KEY secret is missing!"
          echo "Please add HEROKU_API_KEY to your GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "${{ secrets.HEROKU_EMAIL }}" ]; then
          echo "‚ùå HEROKU_EMAIL secret is missing!"
          echo "Please add HEROKU_EMAIL to your GitHub repository secrets"
          exit 1
        fi
        
        echo "‚úÖ Required secrets found"
        
        # Install Heroku CLI
        curl https://cli-assets.heroku.com/install.sh | sh
        
        # Add Heroku to PATH
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
        # Login to Heroku using API key
        echo ${{ secrets.HEROKU_API_KEY }} | heroku auth:token
        
        # Alternative authentication method
        heroku auth:token ${{ secrets.HEROKU_API_KEY }}
        
        # Verify authentication
        heroku auth:whoami || {
          echo "‚ùå Heroku authentication failed"
          echo "üîç Trying alternative authentication method..."
          echo ${{ secrets.HEROKU_API_KEY }} > ~/.netrc
          echo "machine api.heroku.com" >> ~/.netrc
          echo "  login ${{ secrets.HEROKU_EMAIL }}" >> ~/.netrc
          echo "  password ${{ secrets.HEROKU_API_KEY }}" >> ~/.netrc
          echo "machine git.heroku.com" >> ~/.netrc
          echo "  login ${{ secrets.HEROKU_EMAIL }}" >> ~/.netrc
          echo "  password ${{ secrets.HEROKU_API_KEY }}" >> ~/.netrc
          chmod 600 ~/.netrc
        }
        
        # Ensure app is configured for Docker deployment
        heroku stack:set container --app ${{ env.HEROKU_APP_NAME }} || echo "App already set to container stack"
        
        # Remove any existing buildpacks to force Docker-only deployment
        heroku buildpacks:clear --app ${{ env.HEROKU_APP_NAME }} || echo "No buildpacks to clear"
        
        # Explicitly set no buildpacks
        heroku buildpacks:set --index 1 --app ${{ env.HEROKU_APP_NAME }} || echo "No buildpacks to set"
        
        # Verify we're using container stack
        echo "üîç Current Heroku stack:"
        heroku stack --app ${{ env.HEROKU_APP_NAME }}
        
        # Ensure no buildpacks are configured
        echo "üîç Current buildpacks:"
        heroku buildpacks --app ${{ env.HEROKU_APP_NAME }} || echo "No buildpacks configured"
        
        # Check if app exists and create it if needed
        echo "üîß Checking if app exists..."
        if ! heroku apps:info --app ${{ env.HEROKU_APP_NAME }} >/dev/null 2>&1; then
          echo "üì± Creating new Heroku app with container stack..."
          heroku create ${{ env.HEROKU_APP_NAME }} --stack container
        else
          echo "‚úÖ App already exists"
          # Ensure existing app is on container stack
          echo "üîß Setting app to container stack..."
          heroku stack:set container --app ${{ env.HEROKU_APP_NAME }}
        fi
        
        # Verify app.json configuration
        echo "üîß Verifying container deployment configuration..."
        cat app.json
        
        # Final authentication verification
        echo "üîê Verifying Heroku authentication..."
        if heroku auth:whoami; then
          echo "‚úÖ Heroku authentication successful"
        else
          echo "‚ùå Heroku authentication failed - cannot proceed"
          exit 1
        fi
        
    - name: üê≥ Build and Push Docker Container
      run: |
        # Verify we have the necessary files
        echo "üîç Checking for required files..."
        ls -la
        echo "üì¶ Package files:"
        ls -la package*
        
        # Try heroku container:push first, fallback to manual Docker if needed
        echo "üöÄ Attempting heroku container:push..."
        if heroku container:push web --force --app ${{ env.HEROKU_APP_NAME }}; then
          echo "‚úÖ heroku container:push succeeded"
        else
          echo "‚ö†Ô∏è heroku container:push failed, trying manual Docker deployment..."
          
          # Login to Heroku Container Registry
          echo ${{ secrets.HEROKU_API_KEY }} | docker login --username=${{ secrets.HEROKU_EMAIL }} --password-stdin registry.heroku.com
          
          # Build Docker image
          echo "üèóÔ∏è Building Docker image..."
          docker build -t registry.heroku.com/${{ env.HEROKU_APP_NAME }}/web .
          
          # Push to Heroku Container Registry
          echo "üì§ Pushing to Heroku Container Registry..."
          docker push registry.heroku.com/${{ env.HEROKU_APP_NAME }}/web
          
          # Release the container
          echo "üöÄ Releasing container..."
          heroku container:release web --app ${{ env.HEROKU_APP_NAME }}
        fi
        
        # Verify container is running
        echo "üîç Verifying container deployment..."
        heroku ps --app ${{ env.HEROKU_APP_NAME }}
        
    - name: üîß Configure environment variables
      run: |
        heroku config:set NODE_ENV=production --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set PORT=3000 --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set TEST_MODE=false --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set SHOW_JSON_PAYLOAD=false --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set ASSIGNMENT_FEE_MIN=10000 --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set DEFAULT_DISPO_WINDOW=45 --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" --app ${{ env.HEROKU_APP_NAME }}
        
        # Set additional server configuration
        heroku config:set HOST=0.0.0.0 --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set LOG_LEVEL=info --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set OPENAI_MODEL=gpt-4o-mini --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set SLACK_BOT_TOKEN="${{ secrets.SLACK_BOT_TOKEN }}" --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set SLACK_SIGNING_SECRET="${{ secrets.SLACK_SIGNING_SECRET }}" --app ${{ env.HEROKU_APP_NAME }}
        heroku config:set SLACK_APP_TOKEN="${{ secrets.SLACK_APP_TOKEN }}" --app ${{ env.HEROKU_APP_NAME }}
        
    - name: üóÑÔ∏è Setup MongoDB (MongoDB Atlas)
      run: |
        # Add MongoDB Atlas addon (requires credit card)
        heroku addons:create mongolab:sandbox --app ${{ env.HEROKU_APP_NAME }} || echo "MongoDB Atlas addon not available"
        
        # Get MongoDB connection string and set it
        MONGODB_URI=$(heroku config:get MONGODB_URI --app ${{ env.HEROKU_APP_NAME }})
        if [ -n "$MONGODB_URI" ]; then
          echo "‚úÖ MongoDB URI found: $MONGODB_URI"
        else
          echo "‚ö†Ô∏è MongoDB URI not found, setting default"
          MONGODB_URI="mongodb://localhost:27017/acquisitions_agent"
        fi
        
        # Set MongoDB URI in Heroku config
        heroku config:set MONGODB_URI="$MONGODB_URI" --app ${{ env.HEROKU_APP_NAME }}
        
        # Verify all environment variables are set
        echo "üîç Verifying environment variables..."
        heroku config --app ${{ env.HEROKU_APP_NAME }}
        
    - name: ‚úÖ Health check
      run: |
        # Wait for deployment
        sleep 60
        
        # Test application health
        curl -f https://${{ env.HEROKU_APP_NAME }}.herokuapp.com/health || {
          echo "‚ùå Health check failed"
          exit 1
        }
        
        echo "‚úÖ Health check passed"
        
    - name: üìä Deployment summary
      run: |
        echo "üéâ Heroku container deployment completed successfully!"
        echo "üåê Your AI Agent is now live at: https://${{ env.HEROKU_APP_NAME }}.herokuapp.com"
        echo "üì± Update your Slack app URL to: https://${{ env.HEROKU_APP_NAME }}.herokuapp.com/slack/events"
        echo "üê≥ Deployed using Docker containers for better reliability and consistency"
