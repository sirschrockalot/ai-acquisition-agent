name: ğŸš€ Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  DROPLET_NAME: ai-acquisition-agent
  REGION: nyc1
  SIZE: s-2vcpu-2gb

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup DigitalOcean credentials
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        
    - name: ğŸ” Get droplet IP
      id: get-ip
      run: |
        DROPLET_IP=$(doctl compute droplet get ${{ env.DROPLET_NAME }} --format IPAddress --no-header)
        echo "droplet_ip=$DROPLET_IP" >> $GITHUB_OUTPUT
        echo "ğŸŒ Droplet IP: $DROPLET_IP"
        
    - name: ğŸ“ Copy deployment files
      run: |
        scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          Dockerfile docker-compose.yml .dockerignore \
          ubuntu@${{ steps.get-ip.outputs.droplet_ip }}:~/
          
    - name: ğŸ”§ Deploy application
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${{ steps.get-ip.outputs.droplet_ip }} << 'EOF'
          # Navigate to app directory
          cd ai-acquisition-agent
          
          # Pull latest changes
          git pull origin main
          
          # Create production environment file
          cat > .env << 'ENVEOF'
        NODE_ENV=production
        PORT=3000
        TEST_MODE=false
        SHOW_JSON_PAYLOAD=false
        ASSIGNMENT_FEE_MIN=10000
        DEFAULT_DISPO_WINDOW=45
        MONGODB_URI=mongodb://admin:password@localhost:27017/acquisitions_agent?authSource=admin
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
        SLACK_SIGNING_SECRET=${{ secrets.SLACK_SIGNING_SECRET }}
        SLACK_APP_TOKEN=${{ secrets.SLACK_APP_TOKEN }}
        ENVEOF
          
          # Stop existing containers
          docker-compose down
          
          # Build and start new containers
          docker-compose up -d --build
          
          # Wait for containers to be ready
          sleep 30
          
          # Check status
          docker-compose ps
          
          echo "ğŸš€ Deployment completed successfully!"
        EOF
        
    - name: âœ… Health check
      run: |
        # Wait for application to be ready
        sleep 60
        
        # Test application health
        curl -f http://${{ steps.get-ip.outputs.droplet_ip }}:3000/health || {
          echo "âŒ Health check failed"
          exit 1
        }
        
        echo "âœ… Health check passed"
        
    - name: ğŸ“Š Deployment summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Your AI Agent is now live at: http://${{ steps.get-ip.outputs.droplet_ip }}:3000"
        echo "ğŸ“± Update your Slack app URL to: http://${{ steps.get-ip.outputs.droplet_ip }}:3000/slack/events"
